<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
       
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    
    <style>
    .col{
     min-height: 400px;
     }
     .cusblock{
     display:none;
     }
     #customers{
     display:inline-block;
     padding:10px;
     }
     <?!= include('stylesheet'); ?>
    </style>
  </head>
<body>
   <div class='container-flexible'>
      <div class="row"  style = 'margin-right: 0; margin-left: 10px;'>
        
         <div class="col-12">
            <!--  <div class="row" >
               <div class="col">
                  Address Generator here 
                  <div  id='addresses'>
                 <table>
                   <tr> <td>Street:</td><td><div class="input-group"><input type="text" id="Street" class="form-control"  aria-describedby="sizing-addon2"></div></td></tr>
                   <tr> <td>City:</td><td><div class="input-group"><input type="text" id="City" class="form-control"  aria-describedby="sizing-addon2"></div></td></tr>
                   <tr> <td>Town:</td><td><div class="input-group"><input type="text" id="Town" class="form-control"  aria-describedby="sizing-addon2"></div></td></tr>
                   <tr> <td>Post Code:</td><td><div class="input-group"><input type="text" id="Zip" class="form-control"  aria-describedby="sizing-addon2"></div></td></tr>
                  </table>
                  </div>
               </div>
            </div>-->
            <div class="row">
               <div class="col" id='customers'> 
                  <b>Customer</b>
                  <div id='custdropdown'></div>
                
                   <input  class="form-control"  id="custNAME" placeholder='Name' style="display:none;" />
                     <input  class="form-control"  id="custADDRESS" placeholder='Address'  style="display:none;"  />
               </div>
                <div class="col" style = " padding:10px;" >
                  <b>Order ID</b>
                <div class="input-group">
                        <input type="text" class="form-control" name="orderID" id="orderID" placeholder="Order ID" />
                     </div>
                </div>
                
           <div class="col"  style = " padding:10px;">
            <!-- Date here -->
            <b>Order Date</b>
            <div class="input-group"><input type="date" id="orderDate" class="form-control" placeholder="Order Date" aria-describedby="sizing-addon2"></div>
         </div>
         
          
               <div class="col" id='logo'>
                  <!-- LOGO here -->
                  <img src="https://drive.google.com/uc?export=view&id=<?= LOGOIMG?>">
               </div> 
     
      </div>
            <div class="row" >
               <div class="col"  id='forms'>
                  <!-- form body here -->
                  <div id='pageBody'>
                  </div>
               </div>
            </div>   
               <div class="row">
                  <div class="col" >
                     <button id='subModalForm' type="button" class="btn btn-primary" >Submit</button>
                  </div>
               </div>
         
         </div>
         
  </div>
  </div>
</body>
  
  
  <script>
  
  var PCDROP=[];
  var PDDROP=[];
  var pcINPARR=[];
  var pdINPARR=[];
 google.script.run.withSuccessHandler(setOrderID).getNewOrderID();
 function setOrderID(orderID){
 console.log(orderID);
 $('#orderID').val(orderID);
    $('#orderDate').val( (new Date()).toISOString().split('T')[0]);

 
 }
function autofillFORM(data){
console.log("autofillFORM",data);
if(data.recipe){

if(data.type=='PC'){
$('#ORDER_GRID_'+data.num+' #PD'+data.num).val(data.descr);
}else{
$('#ORDER_GRID_'+data.num+' #PC'+data.num).val(data.prod);
}
$('#ORDER_GRID_'+data.num+' #brandSelect').val(data.brandSKU);
$('#ORDER_GRID_'+data.num+' #flavourSelect').val(data.flavour.sku);
$('#ORDER_GRID_'+data.num+' #recipeSelect').val(data.recipe.name);
$('#ORDER_GRID_'+data.num+' #recipeSelect').attr('key',data.recipe.id);
$('#ORDER_GRID_'+data.num+' #bottleType').val(data.botSKU);
$('#ORDER_GRID_'+data.num+' #lidType').val(data.lidSKU);
$('#ORDER_GRID_'+data.num+' #packagingType').val(data.packagingType.sku);
$("select[name='packagingType']").find("option[value='"+data.packagingType.sku+"']").attr("selected",true);

}

}


function searchFOR(event){
  var id=$(event).attr('typ');
var num=$(event).attr('num');
console.log('searchFOR');
 

     if(id=='PC'){
     var val=document.getElementById(pcINPARR[parseInt(num,10)-1][0]).value;
     }else{
     var val=document.getElementById(pdINPARR[parseInt(num,10)-1][0]).value;
     }
     console.log(val,id,num);
            google.script.run.withSuccessHandler(autofillFORM).getFormDataSingle(val,id,num);

  

}
function presetVAL(event){
  var id=$(event).attr('typ');
var num=$(event).attr('num');
console.log('keyup');

    if(id=='PC'){
    setVal3(event,pcINPARR[parseInt(num,10)-1][2],document.getElementById(pcINPARR[parseInt(num,10)-1][0]),pcINPARR[parseInt(num,10)-1][1]);
    }else{
    setVal3(event,pdINPARR[parseInt(num,10)-1][2],document.getElementById(pdINPARR[parseInt(num,10)-1][0]),pdINPARR[parseInt(num,10)-1][1]);
    
    
  
  }
}


RegExp.escape = function (s) {
    return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
};
function show3(event) {

 
  var id=$(event).attr('typ');
   var num=$(event).attr('num');
  console.log(id);
  if(id=='PC'){
  var drop=pcINPARR[parseInt(num,10)-1][2];
  var opt=document.getElementById(pcINPARR[parseInt(num,10)-1][1]);
  var inp=document.getElementById(pcINPARR[parseInt(num,10)-1][0]);
  var arr=PCDROP;
  }else if(id=='PD'){
  var drop=pdINPARR[parseInt(num,10)-1][2];
  var opt=document.getElementById(pdINPARR[parseInt(num,10)-1][1]);
  var inp=document.getElementById(pdINPARR[parseInt(num,10)-1][0]);
  var arr=PDDROP;
  }
console.log(drop);
//document.getElementById('list1').style.display = 'block';
    var dropdown = document.getElementById(drop);
    dropdown.style.display = 'none';

    opt.options.length = 0;

    if (inp.value) {
        dropdown.style.display = 'block';
        opt.size = 3;
        var textCountry = inp.value;

        for (var i = 0; i < arr.length; i++) {
            var testableRegExp = new RegExp(RegExp.escape(textCountry), "i");
            if (String(arr[i]).match(testableRegExp)) {
                addValue3(arr[i], arr[i],opt);

            }
        }
        
        var size = dropdown.children[0].children;
        if (size.length > 0)
        {
           var defaultSize = 16;
           if (size.length < 10)
           {
              defaultSize *= size.length;
           }
           else
           {
              defaultSize *= 10;
           }
           dropdown.children[0].style.height = defaultSize + "px";
        }
        
    }
}

function addValue3(text, val,option) {
    var createOptions = document.createElement('option');
    option.appendChild(createOptions);
    createOptions.text = text;
    createOptions.value = val;
}

//Settin the value in the box by firing the click event
function setVal3(selectedVal,dropdown,inp,type) {

    inp.value = selectedVal.value;
      $(".dropdowns").hide();
     inp.click();
}

  var formdata;
  var numrows=1;

    var orders=[];
    
    google.script.run.withSuccessHandler(buildForm).getFormDataCustomer();

    function buildFormRow(){
        var html = formdata.orderForm;
     

        var brandSelect = '<option id="blanc" value=""></option>';
        for (var i = 0; i < formdata.brands.length; i++) {
            brandSelect += '<option value="' + formdata.brands[i].sku + '">' + formdata.brands[i].name + '<option>';
        } 
        var flavourSelect = '<option id="blanc" value=""></option>';
        for (var i = 0; i < formdata.flavours.length; i++) {
            flavourSelect += '<option value="' + formdata.flavours[i].sku + '">' + formdata.flavours[i].name + '<option>';
        }
        
        var recipeSelect = '<option id="blanc" value=""></option>';
        for (var i = 0; i < formdata.recipes.length; i++) {
            recipeSelect += '<option id="' + formdata.recipes[i][1] + '" value="' + formdata.recipes[i][0] + '" key="' + formdata.recipes[i][1] + '">' + formdata.recipes[i][0] + '<option>';
        }

      
        var bottleSelect = '<option id="blanc" value=""></option>';
        for (var i = 0; i < formdata.bottletypes.length; i++) {
            bottleSelect += '<option value="' + formdata.bottletypes[i].sku + '">' + formdata.bottletypes[i].name + '<option>';
        }
       
        var lidSelect = '<option id="blanc" value=""></option>';
        for (var i = 0; i < formdata.lids.length; i++) {
            lidSelect += '<option value="' + formdata.lids[i].sku + '">' + formdata.lids[i].name + '<option>';
        }
        
        var packagingSelect = '<option id="blanl" value=""></option>';
        for (var i = 0; i < formdata.packagings.length; i++) {
            packagingSelect += '<option id="' + formdata.packagings[i].sku + '" value="' + formdata.packagings[i].sku + '">' + formdata.packagings[i].name + '<option>';
        }
      
 
     html = html.replace('BRAND_SELECT',brandSelect);
     html = html.replace('RECIPE_SELECT',recipeSelect);
     html = html.replace('FLAVOUR_SELECT',flavourSelect);
     html = html.replace('BOTTLE_TYPE_SELECT',bottleSelect);
     html = html.replace('LID_SELECT',lidSelect);
     html = html.replace('PACKAGING_SELECT',packagingSelect)
     
     
     html = html.replace(/ROW_NUM/gm,numrows); 
     
     
     return html;
    
    }
    function buildForm(data) {
    for(var i=0;i<data.PC.length;i++){
    PCDROP.push(data.PC[i].prod);
    
    }
    for(var i=0;i<data.PD.length;i++){
    PDDROP.push(data.PD[i].descr);
    
    }
    
    formdata=data;
    var html = buildFormRow();
    
    
    var custhtml='';
    
    var customerSelect = '<option id="blanl" value=""></option>';
    for (var i = 0; i < data.customers.length; i++) {
    customerSelect += '<option value="' + data.customers[i].sku + '">' + data.customers[i].name + '<option>';
    }
    customerSelect +=  '<option value="New Customer" >New Customer<option>';
    custhtml+= '<select class="form-control" id="customerSelect" onChange="checkifNewCustomer(this)">' + customerSelect + '</select>';
    
    
    $('#pageBody').html(html);
    $('#custdropdown').html(custhtml);
    pcINPARR.push(['PC'+numrows,'listC'+numrows,'dropdownC'+numrows,]);
    pdINPARR.push(['PD'+numrows,'listD'+numrows,'dropdownP'+numrows,]);
    
     
}

function newrow(e) {
 
      numrows++;
 
        var html = buildFormRow();
        $('#pageBody').append(html);
         

         
  pcINPARR.push(['PC'+numrows,'listC'+numrows,'dropdownC'+numrows,]);
 pdINPARR.push(['PD'+numrows,'listD'+numrows,'dropdownP'+numrows,]);

      

 $('#savebtn'+(numrows-1)).css('display','none');
 
 }

    $('#subModalForm').on('click', function(e) {
    
    var orders=[];
      for(var i=0;i<numrows;i++){
      var productcode= $('#ORDER_GRID_'+(i+1)+' #PC'+(i+1)).val();
      if(productcode){
        var date = $('#orderDate').val();
        var batch = '';
        var orderID=$('#orderID').val();
        
        var productdescription= $('#ORDER_GRID_'+(i+1)+' #PD'+(i+1)).val();
        var priority = '';
        if(!newCUSTSelected){
        var customerSKU = $('#customerSelect').val();
        var customerSelect= $('#customerSelect option:selected').text();
        }else{
        var customerSelect = $('#custNAME').val();
        var customerAddress= $('#custADDRESS').val();
       
        }
        var brandSKU = $('#ORDER_GRID_'+(i+1)+' #brandSelect').val();
        var brandSelect= $('#ORDER_GRID_'+(i+1)+' #brandSelect option:selected').text();
        
        var recipeKey = $('option:selected', '#ORDER_GRID_'+(i+1)+' #recipeSelect').attr('key');
        
        var recipeName = $('#ORDER_GRID_'+(i+1)+' #recipeSelect').val();
        var type = $('option:selected', '#ORDER_GRID_'+(i+1)+' #recipeSelect').attr('type');
        var flavourSelect = $('#ORDER_GRID_'+(i+1)+' #flavourSelect').val();
        var flavourName= $('#ORDER_GRID_'+(i+1)+' #flavourSelect option:selected').text();
        
        
        var numBottles = $('#ORDER_GRID_'+(i+1)+' #numBottles').val();
        numBottles = parseInt(numBottles, 10);
        var stocking = 0;
        
        var botSKU = $('#ORDER_GRID_'+(i+1)+' #bottleType').val();
        var bottleType= $('#ORDER_GRID_'+(i+1)+' #bottleType option:selected').text();
        
        var lidSKU = $('#ORDER_GRID_'+(i+1)+' #lidType').val();
        var lidType= $('#ORDER_GRID_'+(i+1)+' #lidType option:selected').text();
        var packagingTypesku = $('#ORDER_GRID_'+(i+1)+' #packagingType').val();
        var packagingTypename= $('#ORDER_GRID_'+(i+1)+' #packagingType option:selected').text();

    /*    
        var Street=$('#Street').val();
        var City=$('#City').val();
        var Town=$('#Town').val();
        var Zip=$('#Zip').val();
        */
//var Location=Street+' '+City+' '+Town+' '+Zip;

        var object = {
            orderID:orderID,
            productcode:productcode,
            productdescription:productdescription,
            orderdate: date,
            batch: batch,
            priority: priority,
            customer: customerSelect,
               customerSKU: customerSKU,
            recipe: {
                id: '',
                name: '',
            },
            brand: brandSelect,
             brandSKU: brandSKU,
            flavour: {
            sku:'',
            name:'',
            },
            bottles: numBottles,
            stocking: stocking,
            btype: bottleType,
            lid: lidType,
            botSKU: botSKU,
            lidSKU: lidSKU,
    
          packagingType:{
          sku:'',
          name:'',
          
          },
          ppp:$('#ORDER_GRID_'+(i+1)+' #prePrintedBottleLabels').is(":checked"),
          ppb:$('#ORDER_GRID_'+(i+1)+' #prePrintedPackLabels').is(":checked"),
          checkUncolored:$('#ORDER_GRID_'+(i+1)+' #checkUncolored').is(":checked"),
        };


        object.packagingType.sku=packagingTypesku;
        object.packagingType.name=packagingTypename;
        object.recipe.name = recipeName;
        object.recipe.id = recipeKey;
        object.flavour.name = flavourName;
        object.flavour.sku = flavourSelect;
        if(newCUSTSelected){
        object.createCustomer=true;
        object.cust={
        
        name:customerSelect,
        address:customerAddress,
        }
       
        }
        orders.push(object);
        }
        }
        google.script.run.withSuccessHandler(newOrderSuccess).saveOrderArray(orders);



    });

    function newOrderSuccess(e) {
       
        alert(e);

    }
  
  var newCUSTSelected=false;
 function checkifNewCustomer(event){
var value = $(event).val();
if(value=='New Customer'){

$(event).hide();
newCUSTSelected=true;
$("#custADDRESS").css('display','inline-block');
$("#custNAME").css('display','inline-block');
}
} 
  
  </script>
</html>


